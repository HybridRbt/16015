/*******************************************************************************
 *              Copyright(c) 2008, Mactronix Inc.
 *              All rights reserved
 *
 *              File:        func.lib
 *              Description: interface functions
 ******************************************************************************/
#use "util.lib"

/*** BeginHeader InitWhole */
int InitWhole();
/*** EndHeader */
int InitWhole()
{
	NmcInit();

	//set servo parameters and enable servo
	if (InitRoller() != NO_ERROR)
		return ERR_FLAT_FIND_FAIL;

	if (RollerHome() != NO_ERROR)
		return ERR_FLAT_FIND_FAIL;

	return NO_ERROR;
}

/*** BeginHeader GetSensorStatus */
xmem int GetSensorStatus();
/*** EndHeader */
/*==============================================================================
 *              GetSensorStatus
 *============================================================================*/
xmem int GetSensorStatus()
{
    /** send sensor's values to host computer */
    int old;
    void *p2, *p3, *p4, *p5, *p6;
    int re;
    unsigned char msgbuf[PCPORTOUTBUFSIZE];   /* buffer for RS232 message */

    int slotnum;

    msgbuf[0] = 5;
    msgbuf[1] = MSG_SENSOR_STATUS;

    //byte 1 to pc
    p2 = &msgbuf[2];
    memset(p2, 0, 1);
    
    for (slotnum = 1; slotnum <= 8; slotnum++)
    {
    	IsWaferInSlot(slotnum) ? set(p2, (slotnum - 1)) : 0;
    }

    //byte 2
    p3 = &msgbuf[3];
    memset(p3, 0, 1);

    for (slotnum = 9; slotnum <= 16; slotnum++)
    {
    	IsWaferInSlot(slotnum) ? set(p3, (slotnum - 9)) : 0;
    }

    //byte 3
    p4 = &msgbuf[4];
    memset(p4, 0, 1);

    for (slotnum = 17; slotnum <= 24; slotnum++)
    {
    	IsWaferInSlot(slotnum) ? set(p4, (slotnum - 17)) : 0;
    }

    //byte 4
    p5 = &msgbuf[5];
    memset(p5, 0, 1);
    IsWaferInSlot(25) ? set(p5, 0) : 0;

    
    IsElevHome() ? set(p5, 0) : 0;
    IsElevLimit() ? set(p5, 1) : 0;
    IsTrayIn() ? set(p5, 2) : 0;
    IsTrayOut() ? set(p5, 3) : 0;
    IsFrontCameraOut() ? set(p5, 4) : 0;
    IsFrontCameraInLimit() ? set(p5, 5) : 0;
    IsTopEpakCassPresent_6() ? 0 : set(p5, 6);
    IsTopEntCassPresent_8() ? 0 : set(p5, 7);

    //5/24/2016 1:42:51 PM no back camera on this model
    //IsBackCameraOut() ? set(p5, 6) : 0;
    //IsBackCameraInLimit() ? set(p5, 7) : 0;
    msgbuf[msgbuf[0] + 1] = '\0';
    /* sensor status must be sent */
    old = g_bSend;
    g_bSend = TRUE;

    if ((re = sendMsg(msgbuf)) != NO_ERROR)
        return re;

    g_bSend = old;
    return NO_ERROR;
}

/*** BeginHeader init */
void init();
/*** EndHeader */
void init()
{
	/** initialize rabbit board, open serial port, and global variables */
	InitIOBoard();
	InitCommPort();
	NmcInit();			//get servo address
}

/*** BeginHeader InitIOBoard */
void InitIOBoard();
/*** EndHeader */
void InitIOBoard()
{
	/**
	 *\code
	 * configure analog/digital port
	 * BL 2600:
	 *   1) 36 digital IO
	 *      - 16 protected digital inputs: DIN16-DIN31, use digIn() to read
	 *      - 4 high-current digital outputs: HOUT0-HOUT3
	 *      - 16 software-configurable as input/output: DIO00-DIO15
	 *   2) 12 analog channels
	 *      - 8 11-bit A/D converter inputs
	 *      - 4 12-bit D/A converter outputs
	 * \endcode
	 */
	int i;
	/* Initialize the board, it must be called at the begining of program */
	brdInit();
	/* Digital High-current outputs: 0 = sinking operation   */
	//digHoutConfig(0x01);
	digHoutConfig(0x00);
	digHTriStateConfig(0x00);

	for (i = 0; i <= 3; i++)
		digHout(i, 1);

	/* 16 configurable I/O(DIO00-DIO15): configure 0 as digital output
	 * Set all digital outputs to be high-impedance state
	 */
	//0000 0000 0000 0001
	//0001
	digOutConfig(0x0001);

	digOut(0, 1);
}

/*** BeginHeader InitCommPort */
void InitCommPort(void);
/*** EndHeader */
void InitCommPort(void)
{
	if (!serCopen(BAUD19200))       //to NMC
		return;

    if (!serEopen(BAUD115200))      //to PC
        return;

	serMode(0);

	// Clear serial data buffers
	serCrdFlush();
	serCwrFlush();

	serErdFlush();
    serEwrFlush();

	serCdatabits(PARAM_8BIT);
	serCparity(PARAM_NOPARITY);

	serEdatabits(PARAM_8BIT);
    serEparity(PARAM_NOPARITY);
}

/*** BeginHeader myinp */
int myinp(int port);
/*** EndHeader */
int myinp(int port)
{
	/** read input port
	  @return 1 or 0    */
	int i, data;
	float temp;

	while (1)
	{
		data = 0;

		for (i = 0; i < 3; i++)
		{
			if (port > 0) //DIO01-DIO15 AND DIN16-DIN31 digital inputs
				data += digIn(port);
		}

		if (data > 2)
			return TRUE;
		else
			return FALSE;
	}
}

/*** BeginHeader boatCheck */
int boatCheck();
/*** EndHeader */
int boatCheck()
{
	if (IsBoatPresent())
		return NO_ERROR;

	ServoStopMotor(ROLLER_MOTOR, AMP_ENABLE | STOP_SMOOTH , 1);
	return ERR_FLAT_FIND_FAIL;
}

/*---------------------------- end of func.lib -------------------------------*/